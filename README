# PostgreSQL High Availability Cluster Kurulumu

## ğŸ“‹ Genel BakÄ±ÅŸ

Bu Ansible playbook koleksiyonu, **PostgreSQL ** iÃ§in yÃ¼ksek eriÅŸilebilirlik (HA) cluster kurulumunu otomatikleÅŸtirir. Sistem aÅŸaÄŸÄ±daki bileÅŸenleri iÃ§erir:

- **2-node PostgreSQL Cluster** (Pacemaker/Corosync)
- **QDevice** ile quorum yÃ¶netimi
- **VMware Fencing** (STONITH)
- **LVM Lock Management** (lvmlockd)
- **Otomatik Failover** ve monitoring

## ğŸ—ï¸ Mimari

### Cluster YapÄ±sÄ±
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚   PostgreSQL    â”‚
â”‚     Node 1      â”‚    â”‚     Node 2      â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ Pacemaker     â”‚    â”‚ â€¢ Pacemaker     â”‚
â”‚ â€¢ Corosync      â”‚    â”‚ â€¢ Corosync      â”‚
â”‚ â€¢ PostgreSQL    â”‚    â”‚ â€¢ PostgreSQL    â”‚
â”‚ â€¢ LVM Locking   â”‚    â”‚ â€¢ LVM Locking   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   QDevice      â”‚
            â”‚    Node        â”‚
            â”‚                â”‚
            â”‚ â€¢ Corosync     â”‚
            â”‚ â€¢ QNetd        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Storage Mimarisi
|  Volume  | Physical Disks                      | Striping  | KullanÄ±m AmacÄ±        |
|----------|-------------------------------------|-----------|-----------------------|
| vg_pgsql | /dev/sdb                            | 1 stripe  | PostgreSQL data files |
| vg_wal   | /dev/sdc,/dev/sdd,/dev/sde,/dev/sdf | 4 stripes | WAL logs              |
| vg_tbs   | /dev/sdg,/dev/sdh,/dev/sdi,/dev/sdj | 4 stripes | Tablespaces           |

## ğŸ“ Dosya YapÄ±sÄ±

```
.
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ hosts
â”œâ”€â”€ playbook/
â”‚   â””â”€â”€ deploy-postgresql-cluster.yml    # Ana cluster playbook
â”‚   â””â”€â”€ deploy-qdevice-node.yml          # QDevice playbook
â”œâ”€â”€ vars/
â”‚   â””â”€â”€ main.yml                         # DeÄŸiÅŸkenler
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ hosts 
â”œâ”€â”€ handlers/
â”‚   â””â”€â”€ main.yml                         # Handler'lar
â””â”€â”€ tasks/
    â”œâ”€â”€ main.yml                    # PostgreSQL
    â”œâ”€â”€ 00_common.yml               # Temel sistem ayarlarÄ±
    â”œâ”€â”€ 01_packages.yml             # Paket kurulumlarÄ±
    â”œâ”€â”€ 02_configuration.yml        # Sistem konfigÃ¼rasyonu
    â”œâ”€â”€ 03_lvm.yml                  # LVM yapÄ±landÄ±rmasÄ±
    â”œâ”€â”€ 04_psql.yml                 # PostgreSQL kurulumu
    â”œâ”€â”€ 05_tuned.yml                # Performance tuning
    â”œâ”€â”€ 06_cluster.yml              # Cluster kurulumu
    â”œâ”€â”€ 07_fence.yml                # Fencing ayarlarÄ±
    â”œâ”€â”€ 08_qdevice.yml              # QDevice entegrasyonu
    â”œâ”€â”€ 09_pcs_ip.yml               # IP kaynaklarÄ±
    â”œâ”€â”€ 10_pcs_timeout.yml          # Timeout ayarlarÄ±
    â”œâ”€â”€ 11_pcs_lvm.yml              # LVM kaynaklarÄ±
    â”œâ”€â”€ 12_pcs_pgsql.yml            # PostgreSQL kaynaklarÄ±
    â””â”€â”€ 13_pcs_smtp.yml             # SMTP alert'leri
    â””â”€â”€ 20_main.yml                 # QDevice
    â””â”€â”€ 21_configuration.yml        # QDevice  Sistem konfigÃ¼rasyonu
    â””â”€â”€ 22_cluster.yml              # QDevice  kurulumu   
```

## ğŸš€ HÄ±zlÄ± BaÅŸlangÄ±Ã§

### Ã–n Gereksinimler

1. **Ansible ** kurulu olmalÄ±

2. **Inventory dosyasÄ± yapÄ±landÄ±rÄ±lmalÄ±:
```bash
vim inventory/hosts
```

3. **DeÄŸiÅŸkenleri gÃ¼ncelle:**
```bash
vim vars/main.yml
```

4. **QDevice node'unu kur:**
```bash
ansible-playbook -i inventory/hosts deploy-qdevice-node.yml -kK
```

5. **PostgreSQL cluster'Ä± kur:**
```bash
ansible-playbook -i inventory/hosts deploy-postgresql-cluster.yml -kK
```

## ğŸ§ª Test SenaryolarÄ±

### 1. Cluster SaÄŸlÄ±k KontrolÃ¼
```bash
# Cluster durumu
pcs status

# Kaynak durumu
pcs resource show

# Quorum durumu
pcs quorum status
```

### 2. Failover Testi
```bash
# Manuel failover
pcs resource move pgsqlsvc

# Maintenance modu
pcs property set maintenance-mode=true
```

### 3. Fencing Testi
```bash
# Fencing device test
pcs stonith fence pgsql01-priv
```

## ğŸ“Š BakÄ±m

### BakÄ±m KomutlarÄ±
```bash
# Cluster bakÄ±mÄ±
pcs cluster stop --all
pcs cluster start --all

# Kaynak temizleme
pcs resource cleanup


## ğŸ› Sorun Giderme

### SÄ±k KarÅŸÄ±laÅŸÄ±lan Sorunlar

1. **Quorum KaybÄ±**
   ```bash
   pcs quorum update expected-votes=2
   ```

2. **Fencing SorunlarÄ±**
   ```bash
   pcs stonith confirm <node_name>
   ```

3. **LVM Lock SorunlarÄ±**
   ```bash
   lvmlockctl --stop-lockspaces
   lvmlockctl --start-lockspaces
   ```

## ğŸ“ˆ Performans OptimizasyonlarÄ±

### Tuned Profili
- **tuned.postgresql** Ã¶zel profili

## ğŸ“„ Lisans

MIT License

## ğŸ†˜ Destek

Ä°letiÅŸim: **BayramGrbz45** - bayramgrbz45@gmail.com

---

**Ã–nemli Not:** Production ortamÄ±nda kullanmadan Ã¶nce mutlaka test ortamÄ±nda tÃ¼m senaryolarÄ± test edin.
